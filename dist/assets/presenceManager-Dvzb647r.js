var h=Object.defineProperty;var l=(s,e,t)=>e in s?h(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t;var r=(s,e,t)=>l(s,typeof e!="symbol"?e+"":e,t);import{s as i,d as a,a as n,b as o,c as d}from"./index-DSQOPZv1.js";class u{constructor(){r(this,"userId",null);r(this,"heartbeatInterval",null);r(this,"isOnline",!1);r(this,"tabId");this.tabId=this.generateTabId(),this.setupEventListeners()}generateTabId(){return`tab_${Date.now()}_${Math.random().toString(36).substr(2,9)}`}setupEventListeners(){window.addEventListener("beforeunload",()=>{this.setOfflineSync()}),document.addEventListener("visibilitychange",()=>{document.hidden?this.reduceHeartbeatFrequency():this.restoreHeartbeatFrequency()}),window.addEventListener("blur",()=>{this.reduceHeartbeatFrequency()}),window.addEventListener("focus",()=>{this.restoreHeartbeatFrequency()}),window.addEventListener("offline",()=>{this.setOfflineSync()}),window.addEventListener("online",()=>{this.userId&&this.setOnline(this.userId)})}async setOnline(e){try{this.userId=e,this.isOnline=!0,await i(a(n,"onlineUsers",`${e}_${this.tabId}`),{userId:e,tabId:this.tabId,lastSeen:o(),isOnline:!0,userAgent:navigator.userAgent,timestamp:Date.now()}),this.startHeartbeat(),console.log("✅ Usuário marcado como online:",e,"Tab:",this.tabId)}catch(t){console.error("❌ Erro ao marcar usuário como online:",t)}}async setOffline(){if(!(!this.userId||!this.isOnline))try{await d(a(n,"onlineUsers",`${this.userId}_${this.tabId}`)),this.stopHeartbeat(),this.isOnline=!1,console.log("✅ Usuário marcado como offline:",this.userId,"Tab:",this.tabId)}catch(e){console.error("❌ Erro ao marcar usuário como offline:",e)}}setOfflineSync(){if(!this.userId||!this.isOnline)return;const e=JSON.stringify({action:"setOffline",userId:this.userId,tabId:this.tabId,timestamp:Date.now()});navigator.sendBeacon&&navigator.sendBeacon("/api/presence-offline",e);try{d(a(n,"onlineUsers",`${this.userId}_${this.tabId}`))}catch{}this.stopHeartbeat(),this.isOnline=!1}startHeartbeat(){this.stopHeartbeat(),this.heartbeatInterval=setInterval(async()=>{if(this.userId&&this.isOnline)try{await i(a(n,"onlineUsers",`${this.userId}_${this.tabId}`),{userId:this.userId,tabId:this.tabId,lastSeen:o(),isOnline:!0,userAgent:navigator.userAgent,timestamp:Date.now()})}catch(e){console.warn("⚠️ Erro no heartbeat:",e)}},3e4)}stopHeartbeat(){this.heartbeatInterval&&(clearInterval(this.heartbeatInterval),this.heartbeatInterval=null)}reduceHeartbeatFrequency(){this.stopHeartbeat(),this.heartbeatInterval=setInterval(async()=>{if(this.userId&&this.isOnline)try{await i(a(n,"onlineUsers",`${this.userId}_${this.tabId}`),{userId:this.userId,tabId:this.tabId,lastSeen:o(),isOnline:!0,userAgent:navigator.userAgent,timestamp:Date.now(),inactive:!0})}catch(e){console.warn("⚠️ Erro no heartbeat reduzido:",e)}},12e4)}restoreHeartbeatFrequency(){this.startHeartbeat()}getTabId(){return this.tabId}isUserOnline(){return this.isOnline}getCurrentUserId(){return this.userId}}const I=new u;export{I as presenceManager};
